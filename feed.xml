<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://www.tonideleo.com/feed.xml" rel="self" type="application/atom+xml"/><link href="https://www.tonideleo.com/" rel="alternate" type="text/html" hreflang="en"/><updated>2026-01-29T08:39:19+00:00</updated><id>https://www.tonideleo.com/feed.xml</id><title type="html">blank</title><subtitle>A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. </subtitle><entry><title type="html">Computational Implementation of the Jacobian Matrix for Implicit Non-Linear FEM Analyses</title><link href="https://www.tonideleo.com/blog/2026/Jacobian-FEM-Implicit/" rel="alternate" type="text/html" title="Computational Implementation of the Jacobian Matrix for Implicit Non-Linear FEM Analyses"/><published>2026-01-26T00:00:00+00:00</published><updated>2026-01-26T00:00:00+00:00</updated><id>https://www.tonideleo.com/blog/2026/Jacobian-FEM-Implicit</id><content type="html" xml:base="https://www.tonideleo.com/blog/2026/Jacobian-FEM-Implicit/"><![CDATA[<p>I wrote this back in 2021 while working on gradient-based optimization techniques to calibrate non-linear material behaviors. It was a different time—before we could just ask an LLM to solve our problems for us. The challenge was straightforward but tricky: explicit finite element algorithms work, but they require many iterations before convergence. For mild non-linearities, implicit solvers are much more efficient, often converging in just a few steps or even a single iteration. The real question was: given a material with a damage variable (starting simple with 1D, though this extends easily to multiple dimensions), how do you compute all the sensitivities in closed form? This document was my solution to that problem. Once I figured it out, I was able to leverage MATLAB’s excellent <code class="language-plaintext highlighter-rouge">fmincon</code> function to handle everything I needed. These days, you could probably ask Claude or ChatGPT and get a more polished answer in seconds. But back then, we had to work through it the old-fashioned way. I learned a lot in the process, and hopefully you’ll find this useful too. Enjoy!</p> <h2 id="introduction">Introduction</h2> <p>The closed-form calculation of the Jacobian Matrix in an implicit scheme within the framework of the Finite Element Method (FEM) can be easily and efficiently implemented during the construction of the global stiffness matrix during the elemental sweep of the simulation domain. To further render the code efficient, particularly for larger scale problems, sparse matrix assembling is used. The format used is the <em>Compressed Sparse Column</em> (CSC) format, typical of MATLAB.</p> <h2 id="sparse-matrix-storage">Sparse Matrix Storage</h2> <p>To give the reader a better understanding of the storage of sparse matrices using the CSC format, consider the following example of a matrix with many zero entries as typical in global stiffness matrices:</p> \[A = \begin{bmatrix} 10 &amp; 20 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 30 &amp; 0 &amp; 40 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 50 &amp; 60 &amp; 70 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 80 \\ \end{bmatrix}\] <p>This matrix can be stored using the <em>triplets</em> arrays instead:</p> \[\begin{gathered} I = \begin{bmatrix}1&amp;1&amp;2&amp;2&amp;3&amp;3&amp;3&amp;4\end{bmatrix}\\ J = \begin{bmatrix} 1&amp;2&amp;2&amp;4&amp;3&amp;4&amp;5&amp;6 \end{bmatrix}\\ W = \begin{bmatrix} 10&amp;20&amp;30&amp;40&amp;50&amp;60&amp;70&amp;80 \end{bmatrix} \end{gathered}\] <p>The arrays $I$ and $J$ are integer arrays which store the row and column, respectively, of the non-zero entries of the $A$ matrix. The size of such arrays is equal to the number of non-zero entries of the $A$ matrix.</p> <p>Computationally speaking, there are two ways to efficiently pre-allocate such arrays:</p> <ol> <li>Calculate the number of non-zero entries and assign the proper size.</li> <li>Pre-allocate the size of a given percentage size of the full matrix first and delete the unused elements after.</li> </ol> <p>Depending on the density of the matrix and initial size, either method could be faster, not necessarily the first one.</p> <p>The arrays $I,J,W$ can also be stored in different orders as long as the triplet coordination is respected. This allows an easy assemblage of the global stiffness matrix, for example, where same entries could also be called multiple times.</p> <p>Another important step is to re-order the sparse matrix using the Cuthill–McKee algorithm. In this way the bandwidth of the matrix is minimized and operations such as inversion are greatly reduced. The figure below shows the difference between a non pre-conditioned (left) matrix and a matrix pre-conditioned using the Cuthill-McKee algorithm (right).</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blog/jacobian-fem/matlab_plot-480.webp 480w,/assets/img/blog/jacobian-fem/matlab_plot-800.webp 800w,/assets/img/blog/jacobian-fem/matlab_plot-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/blog/jacobian-fem/matlab_plot.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> <figcaption class="caption">Graphical representation of non-zero elements in a matrix. Left matrix is not pre-conditioned while the matrix on the right is.</figcaption> </figure> <h2 id="non-linearities-in-fem">Non-Linearities in FEM</h2> <p>Non-linearities in FEM are generally due to: (i) material non-linearities, (ii) large deformation, and (iii) non-linear contacts. In this document, only the first case is explored. Materials can have multiple behaviors, but a simple way to describe many of them is to use a damage variable $D$ which degrades the Young’s modulus $E$. In the example of elastic-perfectly-plastic behavior, the damage variable $D$ can be derived in the following way.</p> <p>Assuming classical Hooke’s law with the addition of the damage factor $D$:</p> \[\sigma = (1-D)E \varepsilon\] <p>and knowing that after plastic initiation $\sigma$ must be equal to the strength $f_t$, we can set the above equation equal to $f_t$ and solve for $D$:</p> \[D = 1 - \frac{f_t}{E \varepsilon}\] <p>This shows the highly non-linear behavior of $D$, as $\varepsilon$ is present in the denominator. The advantage of using the <em>degrading</em> method is that while Hooke’s law seems linear, the degrading factor $D$ (which is itself highly non-linear with respect to $\varepsilon$) can be iterated and the basic linear FEM computational implementation still used.</p> <h2 id="damage-variables-in-1d-bar-elements">Damage Variables in 1D Bar Elements</h2> <p>Assuming the reader knows how to derive the element stiffness matrix of the bar element in 1D, the addition of the damage variable via principle of virtual work is straightforward:</p> \[\begin{Bmatrix} f_1 \\ f_2 \end{Bmatrix} =\frac{E(1-D)A}{L} \begin{bmatrix} 1 &amp; -1 \\ -1 &amp; 1 \end{bmatrix} \begin{Bmatrix} u_1 \\ u_2 \end{Bmatrix}\] <p>And the global system, assembled using standard techniques as outlined below:</p> <div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Number_elements</span>
    <span class="n">counter</span>     <span class="o">=</span>   <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">% Find Nodal Coordinates of Node 1</span>
    <span class="n">N1</span>          <span class="o">=</span>   <span class="n">N</span><span class="p">(</span><span class="n">N</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
    <span class="c1">% Find Nodal Coordinates of Node 2</span>
    <span class="n">N2</span>          <span class="o">=</span>   <span class="n">N</span><span class="p">(</span><span class="n">N</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
    <span class="c1">% Find Length of the Element</span>
    <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>        <span class="o">=</span>   <span class="n">N2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">N1</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="c1">% Find Element Property ID</span>
    <span class="n">propID</span>      <span class="o">=</span>   <span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="k">end</span><span class="p">);</span>
    <span class="c1">% Find Element Cross Sectional Area</span>
    <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>        <span class="o">=</span>   <span class="n">P</span><span class="p">(</span><span class="n">P</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">propID</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
    <span class="c1">% Find Element Material ID</span>
    <span class="n">propMAT</span>     <span class="o">=</span>   <span class="n">P</span><span class="p">(</span><span class="n">P</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">propID</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="c1">% Find Young Modulus</span>
    <span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>     <span class="o">=</span>   <span class="n">M</span><span class="p">(</span><span class="n">M</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">propMAT</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="c1">% Find Strength</span>
    <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>       <span class="o">=</span>   <span class="n">M</span><span class="p">(</span><span class="n">M</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">propMAT</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>

    <span class="n">K_local</span><span class="p">{</span><span class="n">i</span><span class="p">}</span>  <span class="o">=</span>   <span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">D</span><span class="p">(</span><span class="n">i</span><span class="p">))/</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span>
    
    <span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">}</span>   <span class="o">=</span>   <span class="p">[(</span><span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">),</span><span class="k">...</span>
                     <span class="p">(</span><span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">)];</span>       
    <span class="c1">% Assembly in the Global Stiffness Matrix</span>
    <span class="n">K_global</span><span class="p">(</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">})</span> <span class="o">=</span> <span class="k">...</span>
                    <span class="n">K_global</span><span class="p">(</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">})</span> <span class="o">+</span> <span class="n">K_local</span><span class="p">{</span><span class="n">i</span><span class="p">};</span>
                    
    <span class="c1">% If using sparse matrices, triplets are saved instead</span>
    <span class="n">counterb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span>
        <span class="n">counterb</span>            <span class="o">=</span>   <span class="n">counterb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">I</span><span class="p">(</span><span class="n">counterb</span><span class="p">)</span>     <span class="o">=</span>   <span class="n">j</span><span class="p">;</span>
            <span class="n">J</span><span class="p">(</span><span class="n">counterb</span><span class="p">)</span>     <span class="o">=</span>   <span class="n">k</span><span class="p">;</span>
            <span class="n">W</span><span class="p">(</span><span class="n">counterb</span><span class="p">)</span>     <span class="o">=</span>   <span class="n">Klocal</span><span class="p">{</span><span class="n">i</span><span class="p">}(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>is generally written in matrix form as:</p> \[\{F\} = [K]\{d\}\] <p>which after applying boundary conditions is written in reduced form:</p> \[\{F^{\text{red}}\} = [K^{\text{red}}]\{d^{\text{red}}\}\] <p>Since now $D$ is non-linear, simple inversion of the $[K^{\text{red}}]$ cannot be done, and an iterative method must be used. The simplest to start with is the Newton-Raphson method. As a side note, multiple methods and hybrid or modified Newton methods are generally used, but are out of the scope of this document.</p> <h2 id="newton-raphson-method">Newton-Raphson Method</h2> <p>During the Newton-Raphson step, the non-linear equilibrium equations can be approximated as:</p> \[\begin{gathered} K^{\text{red}}(u_1 + \Delta u_1,\cdots,u_n + \Delta u_n) \begin{Bmatrix} u_1 + \Delta u_1 \\ \vdots \\ u_n + \Delta u_n \end{Bmatrix} - \{d^{\text{red}}\} = \{O\} \\ \approx K^{\text{red}}(u_1,\cdots,u_n) \begin{Bmatrix} u_1 \\ \vdots \\ u_n \end{Bmatrix} - \{d^{\text{red}}\} + J(u_1,\cdots,u_n) \begin{Bmatrix} \Delta u_1 \\ \vdots \\ \Delta u_n \end{Bmatrix} \end{gathered}\] <p>where $J(u_1,\cdots,u_n)$ is the Jacobian matrix.</p> <p>A clear example of a 2 DOF system should clarify how to construct the Jacobian Matrix $J$:</p> \[\begin{gathered} K^{\text{red}}(u_1 + \Delta u_1,u_2 + \Delta u_2) \begin{Bmatrix} u_1 + \Delta u_1 \\ u_2 + \Delta u_2 \end{Bmatrix} - \begin{Bmatrix} F_1 \\ F_2 \end{Bmatrix} = \begin{Bmatrix} 0 \\ 0 \end{Bmatrix} \\ \approx \begin{bmatrix} K_{11} &amp; K_{12} \\ K_{21} &amp; K_{22}\end{bmatrix} \begin{Bmatrix} u_1 \\ u_2 \end{Bmatrix} - \begin{Bmatrix} F_1 \\ F_2 \end{Bmatrix} + \\ \begin{bmatrix} \dfrac{\partial}{\partial u_1}(K_{11} u_1 + K_{12} u_2 - F_1) &amp; \dfrac{\partial}{\partial u_2}(K_{11} u_1 + K_{12} u_2 - F_1) \\ \dfrac{\partial}{\partial u_1}(K_{21} u_1 + K_{22} u_2 - F_2) &amp; \dfrac{\partial}{\partial u_2}(K_{21} u_1 + K_{22} u_2 - F_2) \end{bmatrix} \begin{Bmatrix} \Delta u_1 \\ \Delta u_2 \end{Bmatrix} \end{gathered}\] <p>where the reduced global stiffness matrix components $K_{11}$ to $K_{22}$ are assembled by sweeping over the elements in the domain and filling the corresponding DOF of each local elemental stiffness matrix into the global one.</p> <p>At this point, the new increments are found using:</p> \[\begin{Bmatrix} \Delta u_1 \\ \vdots \\ \Delta u_n \end{Bmatrix} = -J(u_1,\cdots,u_n)^{-1} \left\{ K^{\text{red}}(u_1,\cdots,u_n) \begin{Bmatrix} u_1 \\ \vdots \\ u_n \end{Bmatrix} - \{d^{\text{red}}\} \right\}\] <p>and the updated nodal displacements are found iteratively as:</p> \[\begin{Bmatrix} u_1 \\ \vdots \\ u_n \end{Bmatrix}^{\text{new}} = \begin{Bmatrix} u_1 \\ \vdots \\ u_n \end{Bmatrix}^{\text{old}} + \begin{Bmatrix} \Delta u_1 \\ \vdots \\ \Delta u_n \end{Bmatrix}\] <p>by minimizing the following tolerance:</p> \[\left\Vert [K^{\text{red}}] \{u_n\} - \{d^{\text{red}}\} \right\Vert &lt; 10^{-6}\] <h2 id="assembly-of-the-jacobian-matrix">Assembly of the Jacobian Matrix</h2> <p>The tricky part is to systematically assemble the Jacobian matrix given any geometry and element connectivity matrix. This can be easily achieved with the introduction of a 3D matrix (similarly to a 3rd order tensor, even though it does not satisfy tensor properties) of the following form:</p> \[\frac{\partial K}{\partial u}(i,j,k)\] <p>where the derivatives of the global (or reduced) stiffness matrix with respect to each DOF $u$ are stored. The indices $i,j$ follow the DOF convention of the model, while the index $k$ refers to the differentiation index. The figure below is a visual representation of the 3D matrix.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blog/jacobian-fem/plot_jacobian-480.webp 480w,/assets/img/blog/jacobian-fem/plot_jacobian-800.webp 800w,/assets/img/blog/jacobian-fem/plot_jacobian-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/blog/jacobian-fem/plot_jacobian.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> <figcaption class="caption">Visual representation of the 3D matrix which contains the derivatives of the global stiffness matrix with respect to each DOF.</figcaption> </figure> <p>Now, it is possible to add a simple if-condition to the assembly code in order to start assembling the 3D matrix, which must be pre-allocated properly outside of the elemental loop. If the condition of plasticity is satisfied, the damage variable is calculated (by either using elemental strain or nodal displacements) and the 3D matrix filled element by element:</p> <div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">% e(i) = axial strain of element i</span>
<span class="c1">% This if-condition is satisfied at plastic phase</span>
<span class="k">if</span> <span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1">% Calculate Damage Variable of the element</span>
    <span class="n">D</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>       <span class="o">=</span>   <span class="mi">1</span> <span class="o">-</span> <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/(</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>   
    <span class="c1">% Calculate Derivative of the Damage Variable wrt nodal displacements</span>
    <span class="n">dDdu</span><span class="p">(</span><span class="n">i</span><span class="p">,:)</span>  <span class="o">=</span>   <span class="p">[</span><span class="o">-</span> <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="p">/</span> <span class="p">(</span><span class="o">-</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span><span class="k">...</span>
                    <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="p">/</span> <span class="p">(</span><span class="o">-</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">^</span><span class="mi">2</span><span class="p">];</span>
    <span class="c1">% Fill the local dKdu and global one</span>
    <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">size</span><span class="p">(</span><span class="n">dDdu</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dK_local</span><span class="p">{</span><span class="n">i</span><span class="p">}(:,:,</span><span class="n">j</span><span class="p">)</span>  <span class="o">=</span>   <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.*-</span><span class="n">dDdu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)/</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="n">dK_global</span><span class="p">(</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">}(</span><span class="n">j</span><span class="p">))</span>    <span class="o">=</span>    <span class="n">dK_local</span><span class="p">{</span><span class="n">i</span><span class="p">}(:,:,</span><span class="n">j</span><span class="p">);</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>where the derivative of the local elemental stiffness matrix is found using the following steps:</p> \[\frac{\partial K}{\partial u} = \frac{\partial}{\partial u} \left(\frac{A E (1-D)}{L} \begin{bmatrix} 1 &amp; -1 \\ -1 &amp; 1 \end{bmatrix} \right ) = \frac{A E}{L} \begin{bmatrix} -\frac{\partial D}{\partial u} &amp; \frac{\partial D}{\partial u} \\ \frac{\partial D}{\partial u} &amp; -\frac{\partial D}{\partial u} \end{bmatrix}\] <p>or simply:</p> \[\frac{\partial K}{\partial u} = -\text{sign}(K) \cdot \frac{\partial D}{\partial u}\] <p>please note the negative sign in front of the $\text{sign}$ operator.</p> <p>Now, the full Jacobian matrix $J$ can be calculated as shown above by using the following code:</p> <div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">% Pre-allocate the size of the Jacobian matrix</span>
<span class="c1">% This step is performed after reducing the global stiffness matrix</span>
<span class="c1">% rowes_to_keep = DOF not eliminated by BC</span>
<span class="c1">% u_old are the previous Newton step nodal displacements</span>
<span class="c1">% F_reduced are the reduced nodal forces from {F} = [K]{u}</span>
<span class="c1">% F_nh are the non-homogeneous nodal forces due to prescribed BC</span>
<span class="n">J</span>   <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">rowes_to_keep</span><span class="p">));</span>
<span class="n">counteri</span>    <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
<span class="n">counterj</span>    <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="n">rowes_to_keep</span>
    <span class="n">counteri</span>    <span class="o">=</span>   <span class="n">counteri</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rowes_to_keep</span>
        <span class="n">counterj</span>    <span class="o">=</span>   <span class="n">counterj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">J</span><span class="p">(</span><span class="n">counterj</span><span class="p">,</span><span class="n">counteri</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">dK_global</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">rowes_to_keep</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="n">u_old</span><span class="p">)</span> <span class="o">-</span> <span class="k">...</span>
                               <span class="n">F_reduced</span> <span class="o">+</span> <span class="k">...</span>
                               <span class="n">F_nh</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">dK_global</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
    <span class="k">end</span>
    <span class="n">counterj</span>    <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
<span class="k">end</span>  
<span class="n">J</span>   <span class="o">=</span>   <span class="n">J</span> <span class="o">+</span> <span class="n">K_global_reduced</span><span class="p">;</span>
</code></pre></div></div> <p>where the double for-loop can be simplified into a vector operation instead, by properly multiplying the rows of the derivative of the stiffness matrix with respect to nodal coordinates with the previous Newton step nodal displacement. Due to laziness, the <code class="language-plaintext highlighter-rouge">dot</code> command was used instead to avoid problems with array orientation in MATLAB. The vectorization of the operation and sparse conversion is very straightforward and left to the reader.</p> <p>Finally, a <code class="language-plaintext highlighter-rouge">while</code> loop can be used to iterate both the Newton step and the incremental load step. As a side note, even if not shown in this document, the choice of the load increment can be dynamic as it can be increased if the previous step converged easily, or properly reduced if not. This will allow for a faster run-time and fewer problems.</p> <h2 id="example-results">Example Results</h2> <p>A final example is shown below where 3 1D bar elements undergo a prescribed displacement where the first element has a slightly lower plastic strength to induce localization and perform better debugging. On the left, a too large load increment step is shown, where the Newton-Raphson fails to properly minimize the tolerance, while on the right a smaller load increment is chosen to keep the tolerance below the wanted threshold at all times.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blog/jacobian-fem/plot_example-480.webp 480w,/assets/img/blog/jacobian-fem/plot_example-800.webp 800w,/assets/img/blog/jacobian-fem/plot_example-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/blog/jacobian-fem/plot_example.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> <figcaption class="caption">Example results of a three-element structure with one element with slightly lower strength to induce localization for debug purposes. Left: too large step purposely used to show convergence issues. Right: much smaller load increment step chosen.</figcaption> </figure> <h2 id="conclusion">Conclusion</h2> <p>In this document, a quick description of the closed-form computational implementation of the Jacobian matrix for Non-Linear Finite Element Analyses is provided. Implicit simulations can be used to speed up analysis of small structures that experience mild non-linearities. If large or extreme non-linearities are expected, then an explicit code should be used instead. Explicit schemes are much easier to implement and conditionally stable.</p> <p>The calculation of the Jacobian matrix can be vectorized, which presents a very big advantage for computational performance. The choice of the load increment step is still a critical choice, but with this guide, you should not have any issue implementing an implicit non-linear simulation. Different damage variables can be used, even contact formulations can still be implemented using this approach. While the example is limited to 3 uni-dimensional bars, the code would work on any type of elements with multiple DOF per node.</p> <hr/> <h2 id="complete-implementation-code">Complete Implementation Code</h2> <p>For those interested in the full implementation, here’s the complete MATLAB code:</p> <div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">clear</span> <span class="nb">all</span><span class="p">;</span> <span class="nb">close</span> <span class="nb">all</span><span class="p">;</span> <span class="nb">clc</span>

<span class="n">Area</span>            <span class="o">=</span>   <span class="mi">20</span><span class="p">;</span>
<span class="n">Length</span>          <span class="o">=</span>   <span class="mi">1</span><span class="p">;</span>
<span class="n">Ef</span>              <span class="o">=</span>   <span class="mi">3000</span><span class="p">;</span>

<span class="n">fea_model</span>       <span class="o">=</span>   <span class="nb">struct</span><span class="p">();</span>

<span class="n">fea_model</span><span class="o">.</span><span class="n">P</span>     <span class="o">=</span>   <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Area</span><span class="p">;</span>
                     <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Area</span><span class="p">];</span>
<span class="c1">% [MatID, E]</span>
<span class="n">fea_model</span><span class="o">.</span><span class="n">M</span>     <span class="o">=</span>   <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ef</span><span class="p">,</span> <span class="mi">50</span><span class="p">;</span>
                     <span class="mi">2</span><span class="p">,</span> <span class="n">Ef</span><span class="p">,</span> <span class="mi">49</span><span class="p">];</span>                 

<span class="n">fea_model</span><span class="o">.</span><span class="n">F</span>     <span class="o">=</span>   <span class="p">[];</span>
                 
<span class="n">fea_model</span><span class="o">.</span><span class="n">N</span>     <span class="o">=</span>   <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">;</span>
                     <span class="mi">2</span><span class="p">,</span> <span class="n">Length</span><span class="p">;</span>
                     <span class="mi">3</span><span class="p">,</span> <span class="n">Length</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
                     <span class="mi">4</span><span class="p">,</span> <span class="n">Length</span><span class="o">*</span><span class="mi">3</span><span class="p">];</span>                 
<span class="c1">% [Element Number, N1, N2, P]</span>
<span class="n">fea_model</span><span class="o">.</span><span class="n">E</span>     <span class="o">=</span>   <span class="p">[</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span><span class="p">;</span>
                     <span class="mi">2</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">1</span><span class="p">;</span>
                     <span class="mi">3</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">1</span><span class="p">];</span> 
                 
<span class="n">fea_model</span><span class="o">.</span><span class="n">BC</span>    <span class="o">=</span>   <span class="p">[</span><span class="mi">1</span> <span class="mi">1</span><span class="p">];</span>
<span class="c1">% [Node, X, Y]</span>
<span class="n">fea_model</span><span class="o">.</span><span class="n">BC_NH</span> <span class="o">=</span>   <span class="p">[</span><span class="mi">4</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">Length</span><span class="p">];</span>                        

<span class="c1">% Calculate total number of nodes</span>
<span class="n">Number_nodes</span>            <span class="o">=</span>   <span class="nb">size</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="c1">% DOF per node</span>
<span class="n">Node_element</span>            <span class="o">=</span>   <span class="mi">2</span><span class="p">;</span>
<span class="n">DOF_node</span>                <span class="o">=</span>   <span class="mi">1</span><span class="p">;</span>
<span class="c1">% Calculate total number of Degrees of Freedom</span>
<span class="n">DOF_total</span>               <span class="o">=</span>   <span class="n">Number_nodes</span><span class="o">*</span><span class="n">DOF_node</span><span class="p">;</span>
<span class="c1">% Calculate total number of Elements</span>
<span class="n">Number_elements</span>         <span class="o">=</span>   <span class="nb">size</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">E</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">% Presize Variables to save computational time</span>
<span class="n">counter</span>                 <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
<span class="n">F</span>                       <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">DOF_total</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">F_nh</span>                    <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">DOF_total</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">% Stiffness Matrix</span>
<span class="n">K_local</span>                 <span class="o">=</span>   <span class="nb">cell</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="n">K_global</span>                <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">DOF_total</span><span class="p">);</span>
<span class="n">dK_global</span>               <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">DOF_total</span><span class="p">,</span><span class="n">DOF_total</span><span class="p">,</span><span class="n">DOF_total</span><span class="p">);</span>
<span class="n">dK_local</span>                <span class="o">=</span>   <span class="nb">cell</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">dDdu</span>                    <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">% Elemental Quantity</span>
<span class="n">RotMat</span>                  <span class="o">=</span>   <span class="nb">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Number_elements</span><span class="p">);</span>  
<span class="n">L</span>                       <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">C</span>                       <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">S</span>                       <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">Emod</span>                    <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">A</span>                       <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">E_conn</span>                  <span class="o">=</span>   <span class="nb">cell</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">D</span>                       <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">e</span>                       <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">ft</span>                      <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">Number_elements</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">u</span>           <span class="o">=</span>   <span class="mf">0.1</span><span class="o">*</span><span class="n">Length</span><span class="p">;</span>
<span class="n">du</span>          <span class="o">=</span>   <span class="n">u</span><span class="p">/</span><span class="mi">100</span><span class="p">;</span>
<span class="n">u_applied</span>   <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
<span class="n">itermax</span>     <span class="o">=</span>   <span class="mi">1000</span><span class="p">;</span>

<span class="n">dt</span>          <span class="o">=</span>   <span class="mf">0.0001</span><span class="p">;</span>  <span class="c1">% Time Step</span>
<span class="n">t</span>           <span class="o">=</span>   <span class="mi">0</span><span class="p">:</span><span class="n">dt</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>   <span class="c1">% Time Domain</span>
<span class="n">t_current</span>   <span class="o">=</span>   <span class="n">dt</span><span class="p">;</span>
<span class="n">counterb</span>     <span class="o">=</span>   <span class="mi">1</span><span class="p">;</span>

<span class="n">u_old</span>       <span class="o">=</span>   <span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">0</span><span class="p">];</span>
<span class="k">while</span> <span class="n">t_current</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">(</span><span class="k">end</span><span class="p">)</span>
    <span class="n">counterb</span>            <span class="o">=</span>   <span class="n">counterb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">t_current</span>           <span class="o">=</span>   <span class="n">t</span><span class="p">(</span><span class="n">counterb</span><span class="p">);</span>
    <span class="n">u_applied</span>           <span class="o">=</span>   <span class="n">t_current</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">;</span>
    
    <span class="n">fea_model</span><span class="o">.</span><span class="n">BC_NH</span>     <span class="o">=</span>   <span class="p">[</span><span class="mi">4</span> <span class="n">u_applied</span><span class="p">];</span> 
    <span class="n">iter</span>                <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
    <span class="n">toll</span>                <span class="o">=</span>   <span class="mi">1</span><span class="p">;</span>
    <span class="n">K_global</span>            <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">DOF_total</span><span class="p">);</span>
    <span class="k">while</span> <span class="n">toll</span> <span class="o">&gt;</span> <span class="mf">1e-9</span> <span class="o">&amp;&amp;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">itermax</span>
        <span class="n">iter</span>        <span class="o">=</span>   <span class="n">iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">K_global</span>    <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">DOF_total</span><span class="p">);</span>
        <span class="n">F</span>           <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">DOF_total</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Number_elements</span>
            <span class="n">counter</span>     <span class="o">=</span>   <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">N1</span>          <span class="o">=</span>   <span class="n">fea_model</span><span class="o">.</span><span class="n">N</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">N</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">fea_model</span><span class="o">.</span><span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
            <span class="n">N2</span>          <span class="o">=</span>   <span class="n">fea_model</span><span class="o">.</span><span class="n">N</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">N</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">fea_model</span><span class="o">.</span><span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>

            <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>        <span class="o">=</span>   <span class="n">N2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">N1</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

            <span class="n">propID</span>      <span class="o">=</span>   <span class="n">fea_model</span><span class="o">.</span><span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="k">end</span><span class="p">);</span>
            <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>        <span class="o">=</span>   <span class="n">fea_model</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">P</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">propID</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
            <span class="n">propMAT</span>     <span class="o">=</span>   <span class="n">fea_model</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">P</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">propID</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
            <span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>     <span class="o">=</span>   <span class="n">fea_model</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">M</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">propMAT</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
            <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>       <span class="o">=</span>   <span class="n">fea_model</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">M</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">propMAT</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">D</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>            <span class="o">=</span>   <span class="mi">1</span> <span class="o">-</span> <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/(</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>   
                <span class="n">dDdu</span><span class="p">(</span><span class="n">i</span><span class="p">,:)</span>       <span class="o">=</span>   <span class="p">[</span><span class="o">-</span> <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="p">/</span> <span class="p">(</span><span class="o">-</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span><span class="k">...</span>
                                       <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="p">/</span> <span class="p">(</span><span class="o">-</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">^</span><span class="mi">2</span><span class="p">];</span>
                
                <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">size</span><span class="p">(</span><span class="n">dDdu</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">dK_local</span><span class="p">{</span><span class="n">i</span><span class="p">}(:,:,</span><span class="n">j</span><span class="p">)</span>  <span class="o">=</span>   <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.*-</span><span class="n">dDdu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)/</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
                    <span class="n">dK_global</span><span class="p">(</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">}(</span><span class="n">j</span><span class="p">))</span>    <span class="o">=</span>    <span class="n">dK_local</span><span class="p">{</span><span class="n">i</span><span class="p">}(:,:,</span><span class="n">j</span><span class="p">);</span>
                <span class="k">end</span>
            <span class="k">end</span>

            <span class="n">K_local</span><span class="p">{</span><span class="n">i</span><span class="p">}</span>  <span class="o">=</span>   <span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">D</span><span class="p">(</span><span class="n">i</span><span class="p">))/</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span>
            
            <span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">}</span>   <span class="o">=</span>   <span class="p">[(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">),</span><span class="k">...</span>
                             <span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">)];</span>       

            <span class="c1">% Assembly in the Global Stiffness Matrix</span>
            <span class="n">K_global</span><span class="p">(</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">})</span> <span class="o">=</span> <span class="k">...</span>
                            <span class="n">K_global</span><span class="p">(</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">})</span> <span class="o">+</span> <span class="n">K_local</span><span class="p">{</span><span class="n">i</span><span class="p">};</span>
        <span class="k">end</span>
        
        <span class="c1">% Loop to populate F</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">F</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
           <span class="n">F</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span> <span class="p">:</span> <span class="n">fea_model</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">fea_model</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
        <span class="k">end</span>

        <span class="c1">% Loop to populate F using Inhomogeneous Boundary Conditions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">BC_NH</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">F_nh</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">BC_NH</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span> <span class="p">:</span> <span class="n">fea_model</span><span class="o">.</span><span class="n">BC_NH</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="k">...</span>
                                                    <span class="n">fea_model</span><span class="o">.</span><span class="n">BC_NH</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
        <span class="k">end</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">transpose</span><span class="p">(</span><span class="nb">find</span><span class="p">(</span><span class="n">F_nh</span><span class="p">))</span>
            <span class="n">F</span>   <span class="o">=</span>   <span class="n">F</span> <span class="o">-</span> <span class="n">K_global</span><span class="p">(:,</span><span class="n">i</span><span class="p">)</span><span class="o">.*</span><span class="n">F_nh</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">end</span>

        <span class="c1">% Initialize Bookkeeping Matrix for Rows and Columns Elimination</span>
        <span class="n">BC_to_eliminate</span>         <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">DOF_total</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">counter</span>                 <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">transpose</span><span class="p">(</span><span class="n">fea_model</span><span class="o">.</span><span class="n">BC</span><span class="p">(:,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">counter</span>                     <span class="o">=</span>   <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">BC_to_eliminate</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>  <span class="o">=</span>   <span class="n">fea_model</span><span class="o">.</span><span class="n">BC</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
        <span class="k">end</span>

        <span class="c1">% Correct for inhomogeneous BC</span>
        <span class="n">BC_to_eliminate</span>         <span class="o">=</span>   <span class="n">BC_to_eliminate</span> <span class="o">+</span> <span class="n">F_nh</span><span class="p">;</span>
        <span class="c1">% Determine Index of Rows and Column to keep or eliminate</span>
        <span class="n">rowes_to_eliminate</span>      <span class="o">=</span>   <span class="nb">find</span><span class="p">(</span><span class="n">BC_to_eliminate</span><span class="p">)</span><span class="o">'</span><span class="p">;</span>
        <span class="n">rowes_to_keep</span>           <span class="o">=</span>   <span class="nb">find</span><span class="p">(</span><span class="o">~</span><span class="n">BC_to_eliminate</span><span class="p">)</span><span class="o">'</span><span class="p">;</span>
        
        <span class="n">J</span>   <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">rowes_to_keep</span><span class="p">));</span>
        <span class="n">counteri</span>    <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
        <span class="n">counterj</span>    <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="n">rowes_to_keep</span>
            <span class="n">counteri</span>    <span class="o">=</span>   <span class="n">counteri</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rowes_to_keep</span>
                <span class="n">counterj</span>    <span class="o">=</span>   <span class="n">counterj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">J</span><span class="p">(</span><span class="n">counterj</span><span class="p">,</span><span class="n">counteri</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">dK_global</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">rowes_to_keep</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="n">u_old</span><span class="p">)</span> <span class="o">-</span> <span class="mi">0</span> <span class="o">+</span> <span class="k">...</span>
                                           <span class="n">F_nh</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">dK_global</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
            <span class="k">end</span>
            <span class="n">counterj</span>    <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
        <span class="k">end</span>  
        
        <span class="c1">% Reduce the Stiffness, Mass, and Force Matrix</span>
        <span class="n">K_global_reduced</span>                            <span class="o">=</span>   <span class="n">K_global</span><span class="p">;</span>
        <span class="n">dK_global_reduced</span>                           <span class="o">=</span>   <span class="n">dK_global</span><span class="p">;</span>
        <span class="n">K_global_reduced</span><span class="p">(</span><span class="n">rowes_to_eliminate</span><span class="p">,</span> <span class="p">:)</span>     <span class="o">=</span>   <span class="p">[];</span>
        <span class="n">K_global_reduced</span><span class="p">(:,</span><span class="n">rowes_to_eliminate</span><span class="p">)</span>      <span class="o">=</span>   <span class="p">[];</span>
        <span class="n">dK_global_reduced</span><span class="p">(:,</span><span class="n">rowes_to_eliminate</span><span class="p">,:)</span>   <span class="o">=</span>   <span class="p">[];</span>
        <span class="n">dK_global_reduced</span><span class="p">(</span><span class="n">rowes_to_eliminate</span><span class="p">,:,:)</span>   <span class="o">=</span>   <span class="p">[];</span>
        
        <span class="n">F_reduced</span>                                   <span class="o">=</span>   <span class="n">F</span><span class="p">;</span>
        <span class="n">F_reduced</span><span class="p">(</span><span class="n">rowes_to_eliminate</span><span class="p">)</span>               <span class="o">=</span>   <span class="p">[];</span>
        
        <span class="n">J</span>       <span class="o">=</span>   <span class="n">K_global_reduced</span> <span class="o">+</span> <span class="n">J</span><span class="p">;</span>
        
        <span class="n">du_new</span>  <span class="o">=</span>   <span class="o">-</span><span class="nb">inv</span><span class="p">(</span><span class="n">J</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">K_global_reduced</span><span class="o">*</span><span class="n">u_old</span> <span class="o">-</span> <span class="n">F_reduced</span><span class="p">);</span>  
        <span class="n">u_new</span>   <span class="o">=</span>   <span class="n">u_old</span> <span class="o">+</span> <span class="n">du_new</span><span class="p">;</span>

        <span class="n">Displacement</span><span class="p">(</span><span class="n">rowes_to_eliminate</span><span class="p">)</span>        <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
        <span class="n">Displacement</span><span class="p">(</span><span class="nb">find</span><span class="p">(</span><span class="n">F_nh</span><span class="p">))</span>                <span class="o">=</span>   <span class="n">u_applied</span><span class="p">;</span>
        <span class="n">Displacement</span><span class="p">(</span><span class="n">rowes_to_keep</span><span class="p">)</span>             <span class="o">=</span>   <span class="n">u_new</span><span class="p">;</span>    
        <span class="n">u</span>           <span class="o">=</span>   <span class="n">fea_model</span><span class="o">.</span><span class="n">N</span><span class="p">;</span>
        <span class="n">counter</span>     <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">Displacement</span><span class="p">)</span>
            <span class="n">counter</span>     <span class="o">=</span>   <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">u</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">)</span>  <span class="o">=</span>   <span class="n">Displacement</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">);</span>
        <span class="k">end</span> 
        <span class="n">K_global</span>    <span class="o">=</span>   <span class="nb">zeros</span><span class="p">(</span><span class="n">DOF_total</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Number_elements</span>
            <span class="n">u_node1</span>     <span class="o">=</span>   <span class="n">u</span><span class="p">(</span><span class="n">u</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">fea_model</span><span class="o">.</span><span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
            <span class="n">u_node2</span>     <span class="o">=</span>   <span class="n">u</span><span class="p">(</span><span class="n">u</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">fea_model</span><span class="o">.</span><span class="n">E</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span> 

            <span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>        <span class="o">=</span>   <span class="p">(</span><span class="n">u_node2</span> <span class="o">-</span> <span class="n">u_node1</span><span class="p">)/</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>        <span class="o">=</span>   <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">D</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">*</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

            <span class="k">if</span> <span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">D</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>            <span class="o">=</span>   <span class="mi">1</span> <span class="o">-</span> <span class="n">ft</span><span class="p">(</span><span class="n">i</span><span class="p">)/(</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">));</span> 
            <span class="k">end</span>
            
            <span class="n">K_local</span><span class="p">{</span><span class="n">i</span><span class="p">}</span>  <span class="o">=</span>   <span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">Emod</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">D</span><span class="p">(</span><span class="n">i</span><span class="p">))/</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span>   

            <span class="c1">% Assembly in Global Stiffness Matrix</span>
            <span class="n">K_global</span><span class="p">(</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">})</span> <span class="o">=</span> <span class="k">...</span>
                            <span class="n">K_global</span><span class="p">(</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">},</span><span class="n">E_conn</span><span class="p">{</span><span class="n">i</span><span class="p">})</span> <span class="o">+</span> <span class="n">K_local</span><span class="p">{</span><span class="n">i</span><span class="p">};</span>            
        <span class="k">end</span>   
        <span class="n">K_global_reduced</span>                            <span class="o">=</span>   <span class="n">K_global</span><span class="p">;</span>
        <span class="n">K_global_reduced</span><span class="p">(</span><span class="n">rowes_to_eliminate</span><span class="p">,</span> <span class="p">:)</span>     <span class="o">=</span>   <span class="p">[];</span>
        <span class="n">K_global_reduced</span><span class="p">(:,</span><span class="n">rowes_to_eliminate</span><span class="p">)</span>      <span class="o">=</span>   <span class="p">[];</span>
        <span class="n">iter</span><span class="p">;</span>
        <span class="n">toll</span>    <span class="o">=</span>   <span class="nb">norm</span><span class="p">(</span><span class="n">K_global_reduced</span><span class="o">*</span><span class="n">u_new</span> <span class="o">-</span> <span class="n">F_reduced</span><span class="p">);</span>
    <span class="k">end</span>
    
    <span class="n">u_old</span>                                   <span class="o">=</span>   <span class="n">u_new</span><span class="p">;</span>
    
    <span class="n">EE</span><span class="p">(</span><span class="n">counterb</span><span class="p">,:)</span>    <span class="o">=</span>   <span class="n">e</span><span class="o">'</span><span class="p">;</span>
    <span class="n">SS</span><span class="p">(</span><span class="n">counterb</span><span class="p">,:)</span>    <span class="o">=</span>   <span class="n">s</span><span class="p">;</span>   
<span class="k">end</span>
    
<span class="nb">figure</span>
<span class="nb">scatter</span><span class="p">(</span><span class="n">EE</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">SS</span><span class="p">(:,</span><span class="mi">1</span><span class="p">));</span> <span class="nb">hold</span> <span class="n">on</span>
<span class="nb">scatter</span><span class="p">(</span><span class="n">EE</span><span class="p">(:,</span><span class="mi">2</span><span class="p">),</span><span class="n">SS</span><span class="p">(:,</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">scatter</span><span class="p">(</span><span class="n">EE</span><span class="p">(:,</span><span class="mi">3</span><span class="p">),</span><span class="n">SS</span><span class="p">(:,</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div></div>]]></content><author><name></name></author><category term="engineering"/><category term="code"/><category term="math"/><summary type="html"><![CDATA[A detailed guide on implementing the Jacobian matrix in implicit finite element simulations with material non-linearities using sparse matrix techniques]]></summary></entry></feed>